import pytz
import logging
import sqlite3
from datetime import datetime
from telegram import (
    Update,
    ReplyKeyboardMarkup,
    InlineKeyboardMarkup,
    InlineKeyboardButton
)
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    CallbackQueryHandler,
    ConversationHandler,
    ContextTypes,
    filters
)

# --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ---
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# --- ØªØ¹Ø±ÙŠÙ Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ---
LOCATION, NAME, PEOPLE, BOOKING_DATE, CONFIRM, TRANSFER_NUMBER = range(6)

# --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© ---
TIMEZONE = pytz.timezone('Asia/Damascus')

# --- ØªØ¹Ø±ÙŠÙ Ø³Ø¹Ø© Ø§Ù„Ø£Ù…Ø§ÙƒÙ† ---
CAPACITY = {
    "bar": 30,
    "winter_pool": 50,
    "kids_pool": 40,
    "summer_pool": 60,
    "hall_side": 45
}

# --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¯ÙØ¹ ---
MERCHANT_PHONE = "0990330431"
PRICE_PER_PERSON = 10000

# --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
DB_NAME = "bookings.db"
ADMINS_DB = "admins.db"


# --- ØªÙ‡ÙŠØ¦Ø© Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
def init_databases():
    conn = sqlite3.connect(DB_NAME)
    c = conn.cursor()
    c.execute('''CREATE TABLE IF NOT EXISTS bookings
                 (id INTEGER PRIMARY KEY AUTOINCREMENT,
                 payment_code TEXT UNIQUE,
                 name TEXT,
                 location TEXT,
                 people INTEGER,
                 amount INTEGER,
                 transfer_number TEXT,
                 status TEXT DEFAULT 'pending',
                 user_id INTEGER,
                 created_at TIMESTAMP,
                 booking_date TEXT)''')
    conn.commit()
    conn.close()

    conn = sqlite3.connect(ADMINS_DB)
    c = conn.cursor()
    c.execute('''CREATE TABLE IF NOT EXISTS admins
                 (user_id TEXT PRIMARY KEY,
                 username TEXT,
                 full_name TEXT,
                 added_at TIMESTAMP)''')
    conn.commit()
    conn.close()


init_databases()


# --- Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ---
def get_current_date():
    return datetime.now(TIMEZONE).strftime('%Y-%m-%d')


def get_current_time():
    return datetime.now(TIMEZONE).strftime('%Y-%m-%d %H:%M:%S')


def is_admin(user_id):
    conn = sqlite3.connect(ADMINS_DB)
    c = conn.cursor()
    c.execute("SELECT * FROM admins WHERE user_id=?", (str(user_id),))
    result = c.fetchone()
    conn.close()
    return result is not None


def add_admin(user_id, username=None, full_name=None):
    conn = sqlite3.connect(ADMINS_DB)
    c = conn.cursor()
    try:
        c.execute("INSERT INTO admins (user_id, username, full_name, added_at) VALUES (?, ?, ?, ?)",
                  (str(user_id), username, full_name, datetime.now()))
        conn.commit()
        return True
    except sqlite3.IntegrityError:
        return False
    finally:
        conn.close()


def get_admin_info(user_id):
    conn = sqlite3.connect(ADMINS_DB)
    c = conn.cursor()
    c.execute("SELECT username, full_name FROM admins WHERE user_id=?", (str(user_id),))
    result = c.fetchone()
    conn.close()
    return {
        "username": result[0] if result else None,
        "full_name": result[1] if result else None
    }


def remove_admin(user_id):
    conn = sqlite3.connect(ADMINS_DB)
    c = conn.cursor()
    c.execute("DELETE FROM admins WHERE user_id=?", (str(user_id),))
    conn.commit()
    rows_affected = c.rowcount
    conn.close()
    return rows_affected > 0


def list_admins():
    conn = sqlite3.connect(ADMINS_DB)
    c = conn.cursor()
    c.execute("SELECT * FROM admins")
    admins = c.fetchall()
    conn.close()
    return admins


async def notify_admins_new_booking(context: ContextTypes.DEFAULT_TYPE, booking_data):
    admins = list_admins()
    if not admins:
        return

    booking_details = (
        f"ğŸ“£ Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯ ÙŠØ­ØªØ§Ø¬ Ù„Ù„Ù…ÙˆØ§ÙÙ‚Ø©:\n\n"
        f"ğŸ†” ÙƒÙˆØ¯ Ø§Ù„Ø­Ø¬Ø²: <code>{booking_data['payment_code']}</code>\n"
        f"ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: {booking_data['name']}\n"
        f"ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹: {booking_data['location']}\n"
        f"ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ø®Ø§Øµ: {booking_data['people']}\n"
        f"ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: {booking_data['amount']:,} Ù„.Ø³\n"
        f"ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø²: {booking_data['booking_date']}\n"
        f"ğŸ‘¤ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {booking_data['user_id']}\n"
    )

    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("âœ… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²", callback_data=f"approve_{booking_data['payment_code']}")]
    ])

    for admin in admins:
        try:
            await context.bot.send_message(
                chat_id=admin[0],
                text=booking_details,
                reply_markup=keyboard
            )
        except Exception as e:
            logger.error(f"ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ {admin[0]}: {str(e)}")


async def notify_user_approval(context: ContextTypes.DEFAULT_TYPE, payment_code):
    conn = sqlite3.connect(DB_NAME)
    c = conn.cursor()
    c.execute("SELECT user_id, name, booking_date FROM bookings WHERE payment_code=?", (payment_code,))
    booking = c.fetchone()
    conn.close()

    if booking:
        user_id, name, booking_date = booking
        message = (
            f"ğŸ‰ ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø­Ø¬Ø²Ùƒ!\n\n"
            f"ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: {name}\n"
            f"ğŸ†” ÙƒÙˆØ¯ Ø§Ù„Ø­Ø¬Ø²: <code>{payment_code}</code>\n"
            f"ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø²: {booking_date}\n\n"
            "Ø´ÙƒØ±Ø§Ù‹ Ù„Ø«Ù‚ØªÙƒ Ø¨Ù†Ø§! Ù†ØªÙ…Ù†Ù‰ Ù„Ùƒ ÙˆÙ‚ØªØ§Ù‹ Ù…Ù…ØªØ¹Ø§Ù‹."
        )

        try:
            await context.bot.send_message(
                chat_id=user_id,
                text=message
            )
        except Exception as e:
            logger.error(f"ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id}: {str(e)}")


def save_booking(data, context: ContextTypes.DEFAULT_TYPE):
    conn = sqlite3.connect(DB_NAME)
    c = conn.cursor()
    try:
        c.execute('''INSERT INTO bookings 
                    (payment_code, name, location, people, amount, transfer_number, user_id, created_at, booking_date)
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)''',
                  (data['payment_code'], data['name'], data['location'],
                   data['people'], data['amount'], data['transfer_number'],
                   data['user_id'], datetime.now(), data['booking_date']))
        conn.commit()

        # Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†
        context.application.create_task(notify_admins_new_booking(context, data))

        return True
    except sqlite3.IntegrityError:
        logger.error("ÙƒÙˆØ¯ Ø§Ù„Ø¯ÙØ¹ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹")
        return False
    finally:
        conn.close()


def approve_booking(payment_code):
    conn = sqlite3.connect(DB_NAME)
    c = conn.cursor()
    c.execute("UPDATE bookings SET status='approved' WHERE payment_code=?", (payment_code,))
    conn.commit()
    rows_affected = c.rowcount
    conn.close()
    return rows_affected > 0


def reject_booking(payment_code, reason=None):
    conn = sqlite3.connect(DB_NAME)
    c = conn.cursor()
    c.execute("UPDATE bookings SET status=?, reject_reason=? WHERE payment_code=?",
              (f'rejected: {reason}' if reason else 'rejected', reason, payment_code))
    conn.commit()
    rows_affected = c.rowcount
    conn.close()
    return rows_affected > 0


def get_pending_bookings():
    conn = sqlite3.connect(DB_NAME)
    c = conn.cursor()
    c.execute("SELECT * FROM bookings WHERE status='pending'")
    bookings = c.fetchall()
    conn.close()
    return bookings


def get_approved_bookings():
    conn = sqlite3.connect(DB_NAME)
    c = conn.cursor()
    c.execute("SELECT * FROM bookings WHERE status='approved' ORDER BY created_at DESC")
    bookings = c.fetchall()
    conn.close()
    return bookings


# --- Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£ÙˆØ§Ù…Ø± ---
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.message.from_user
    admin_info = get_admin_info(user.id) if is_admin(user.id) else None

    welcome_msg = f"""
âœ¨ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ÙˆØ§Ø­Ø© Ø§Ù„Ø´Ø§Ù… âœ¨
ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ: {get_current_date()}

"""

    if admin_info:
        welcome_msg += f"ğŸ‘‘ Ø£Ù†Øª Ù…Ø³Ø¤ÙˆÙ„: {admin_info.get('full_name', user.full_name)}\n"
        if admin_info.get('username'):
            welcome_msg += f"ğŸ“Œ Ø§Ù„ÙŠÙˆØ²Ø±Ù†ÙŠÙ…: @{admin_info['username']}\n"

    welcome_msg += """
ğŸ“ Ø®ÙŠØ§Ø±Ø§ØªÙ†Ø§ Ø§Ù„Ù…ØªØ§Ø­Ø©:
- Ù…Ø³Ø§Ø¨Ø­ Ù†Ø¸ÙŠÙØ© Ø¨Ù…ÙˆØ§ØµÙØ§Øª Ø¹Ø§Ù„ÙŠØ©
- Ù…Ø·Ø¹Ù… Ø±Ø¦ÙŠØ³ÙŠ ÙŠÙ‚Ø¯Ù… ÙˆØ¬Ø¨Ø§Øª Ù…ØªÙ†ÙˆØ¹Ø©

Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©:
"""

    keyboard_layout = [
        ["ğŸŠ Ø§Ù„Ù…Ø³Ø§Ø¨Ø­", "ğŸ½ï¸ Ø§Ù„Ù…Ø·Ø§Ø¹Ù…"],
        ["ğŸ‰ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø®Ø§ØµØ©", "ğŸ“ Ø§ØªØµÙ„ Ø¨Ù†Ø§"],
        ["ğŸ“… Ø­Ø¬Ø² Ø·Ø§ÙˆÙ„Ø©", "ğŸ†” Ù…Ø¹Ø±ÙÙŠ"]
    ]

    if is_admin(user.id):
        keyboard_layout.append(["ğŸ“‹ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§"])

    keyboard = ReplyKeyboardMarkup(
        keyboard_layout,
        resize_keyboard=True,
        input_field_placeholder="Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©..."
    )

    await update.message.reply_text(welcome_msg, reply_markup=keyboard)
    return ConversationHandler.END


async def show_approved_bookings(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.message.from_user
    if not is_admin(user.id):
        await update.message.reply_text("âš ï¸ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©")
        return

    approved_bookings = get_approved_bookings()
    if not approved_bookings:
        await update.message.reply_text("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.")
        return

    total_bookings = len(approved_bookings)
    total_people = sum(booking[4] for booking in approved_bookings)
    total_amount = sum(booking[5] for booking in approved_bookings)

    await update.message.reply_text(
        f"ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§:\n"
        f"â€¢ Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª: {total_bookings}\n"
        f"â€¢ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ø®Ø§Øµ: {total_people}\n"
        f"â€¢ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº: {total_amount:,} Ù„.Ø³\n\n"
        "ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª:"
    )

    for booking in approved_bookings:
        booking_details = (
            f"ğŸ†” ÙƒÙˆØ¯ Ø§Ù„Ø­Ø¬Ø²: <code>{booking[1]}</code>\n"
            f"ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: {booking[2]}\n"
            f"ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹: {booking[3]}\n"
            f"ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ø®Ø§Øµ: {booking[4]}\n"
            f"ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: {booking[5]:,} Ù„.Ø³\n"
            f"ğŸ”¢ Ø±Ù‚Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„: {booking[6]}\n"
            f"ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø²: {booking[10]}\n"
            f"ğŸ‘¤ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {booking[8]}\n"
        )

        await update.message.reply_text(booking_details)


async def show_ids(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    chat = update.effective_chat
    bot = await context.bot.get_me()

    conn = sqlite3.connect(DB_NAME)
    c = conn.cursor()
    c.execute("SELECT COUNT(*) FROM bookings WHERE user_id=?", (user.id,))
    total_bookings = c.fetchone()[0]
    c.execute("SELECT status FROM bookings WHERE user_id=? ORDER BY created_at DESC LIMIT 1", (user.id,))
    last_booking = c.fetchone()
    conn.close()

    last_booking_status = ""
    if last_booking:
        status = last_booking[0]
        last_booking_status = "\nğŸ“… Ø¢Ø®Ø± Ø­Ø¬Ø²: " + (
            "â³ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±" if status == 'pending' else
            "âœ… ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©" if 'approved' in status else
            f"âŒ Ù…Ø±ÙÙˆØ¶ ({status.split(':')[-1]})" if ':' in status else "âŒ Ù…Ø±ÙÙˆØ¶"
        )

    admin_info = ""
    if is_admin(user.id):
        admin_info = "\nğŸ‘‘ Ø£Ù†Øª Ù…Ø³Ø¤ÙˆÙ„ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª\n"

    chat_type = "Ø®Ø§Øµ" if chat.type == "private" else "Ù…Ø¬Ù…ÙˆØ¹Ø©" if chat.type == "group" else "Ù‚Ù†Ø§Ø©"

    response = (
        f"ğŸ†” Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙØ§Øª:\n\n"
        f"ğŸ‘¤ <b>Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ:</b>\n"
        f"- Ø§Ù„Ù…Ø¹Ø±Ù: <code>{user.id}</code>\n"
        f"- Ø§Ù„Ø§Ø³Ù…: {user.full_name}\n"
        f"- Ø§Ù„ÙŠÙˆØ²Ø±: @{user.username if user.username else 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}\n"
        f"- Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª: {total_bookings}"
        f"{last_booking_status}"
        f"{admin_info}\n"
        f"ğŸ’¬ <b>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©:</b>\n"
        f"- Ø§Ù„Ù…Ø¹Ø±Ù: <code>{chat.id}</code>\n"
        f"- Ø§Ù„Ù†ÙˆØ¹: {chat_type}\n"
        f"- Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: {chat.title if hasattr(chat, 'title') else 'Ø¯Ø±Ø¯Ø´Ø© Ø®Ø§ØµØ©'}\n\n"
        f"ğŸ¤– <b>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨ÙˆØª:</b>\n"
        f"- Ø§Ù„Ù…Ø¹Ø±Ù: <code>{bot.id}</code>\n"
        f"- Ø§Ù„ÙŠÙˆØ²Ø±: @{bot.username}\n"
        f"- Ø§Ù„Ø§Ø³Ù…: {bot.full_name}\n\n"
        f"ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ: {get_current_date()}"
    )

    await update.message.reply_html(response)


async def handle_myid_button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await show_ids(update, context)


async def start_booking(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data.clear()
    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("Ø¨Ø§Ø±", callback_data='bar')],
        [InlineKeyboardButton("Ø¬Ø§Ù†Ø¨ Ø§Ù„Ù…Ø³Ø¨Ø­ Ø§Ù„Ø´ØªÙˆÙŠ", callback_data='winter_pool')],
        [InlineKeyboardButton("Ø¬Ø§Ù†Ø¨ Ù…Ø³Ø¨Ø­ Ø§Ù„Ø£Ø·ÙØ§Ù„", callback_data='kids_pool')],
        [InlineKeyboardButton("Ø¬Ø§Ù†Ø¨ Ø§Ù„Ù…Ø³Ø¨Ø­ Ø§Ù„ØµÙŠÙÙŠ", callback_data='summer_pool')],
        [InlineKeyboardButton("Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„ØµØ§Ù„Ø©", callback_data='hall_side')]
    ])

    await update.message.reply_text(
        "ğŸ“ Ø§Ø®ØªØ± Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø·Ø§ÙˆÙ„Ø©:",
        reply_markup=keyboard
    )
    return LOCATION


async def select_location(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    context.user_data['location'] = query.data
    await query.edit_message_text("ğŸ“ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ø­Ø¬Ø²:")
    return NAME


async def get_name(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data['name'] = update.message.text
    await update.message.reply_text("ğŸ‘¥ ÙƒÙ… Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ø®Ø§ØµØŸ (Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ÙÙ‚Ø·)")
    return PEOPLE


async def get_people(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        people = int(update.message.text)
        if people <= 0:
            raise ValueError

        context.user_data['people'] = people
        await update.message.reply_text("ğŸ“… Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø² (YYYY-MM-DD):")
        return BOOKING_DATE

    except ValueError:
        await update.message.reply_text("âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­ Ù…ÙˆØ¬Ø¨")
        return PEOPLE


async def get_booking_date(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        booking_date = update.message.text.strip()
        datetime.strptime(booking_date, '%Y-%m-%d')
        context.user_data['booking_date'] = booking_date

        location = context.user_data['location']
        remaining = CAPACITY[location] - sum(1 for b in get_pending_bookings() if b[3] == location)

        if context.user_data['people'] > remaining:
            await update.message.reply_text(f"âš ï¸ Ø§Ù„Ø¹Ø¯Ø¯ ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ø³Ø¹Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© ({remaining}). Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ Ø£Ù‚Ù„")
            return PEOPLE

        keyboard = InlineKeyboardMarkup([
            [InlineKeyboardButton("âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²", callback_data='confirm')],
            [InlineKeyboardButton("âŒ Ø¥Ù„ØºØ§Ø¡", callback_data='cancel')]
        ])

        await update.message.reply_text(
            f"ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²:\n\nğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹: {location.replace('_', ' ')}\n"
            f"ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: {context.user_data['name']}\n"
            f"ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ø®Ø§Øµ: {context.user_data['people']}\n"
            f"ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø²: {booking_date}\n"
            f"ğŸ’° Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: {context.user_data['people'] * PRICE_PER_PERSON:,} Ù„.Ø³\n"
            f"ğŸª‘ Ø§Ù„Ø³Ø¹Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: {remaining - context.user_data['people']}\n\n"
            "Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²ØŸ",
            reply_markup=keyboard
        )
        return CONFIRM

    except ValueError:
        await update.message.reply_text("âš ï¸ ØµÙŠØºØ© Ø§Ù„ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ­ÙŠØ­Ø©. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØµÙŠØºØ© YYYY-MM-DD")
        return BOOKING_DATE


async def confirm_booking(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    if query.data == 'confirm':
        context.user_data['amount'] = context.user_data['people'] * PRICE_PER_PERSON
        context.user_data['payment_code'] = f"SHAM{datetime.now().strftime('%Y%m%d%H%M%S')}"

        await query.edit_message_text(
            f"ğŸ’° Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:\n\n1. Ø£Ø±Ø³Ù„ Ø§Ù„Ù…Ø¨Ù„Øº {context.user_data['amount']:,} Ù„.Ø³ Ø¥Ù„Ù‰ Ø§Ù„Ø±Ù‚Ù…: {MERCHANT_PHONE}\n"
            "2. Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø¯ÙØ¹\n\n"
            "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ø¹Ø¯ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¯ÙØ¹:"
        )
        return TRANSFER_NUMBER
    else:
        await query.edit_message_text("âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¬Ø²")
        return ConversationHandler.END


async def get_transfer_number(update: Update, context: ContextTypes.DEFAULT_TYPE):
    transfer_number = update.message.text.strip()

    if not transfer_number.isdigit():
        await update.message.reply_text("âš ï¸ Ø±Ù‚Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„ ØºÙŠØ± ØµØ§Ù„Ø­. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµØ­ÙŠØ­:")
        return TRANSFER_NUMBER

    context.user_data['transfer_number'] = transfer_number
    context.user_data['user_id'] = update.message.from_user.id

    if save_booking(context.user_data, context):
        await update.message.reply_text(
            "âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨ Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­\n\n"
            "ØªÙØ§ØµÙŠÙ„ Ø·Ù„Ø¨Ùƒ:\n"
            f"ÙƒÙˆØ¯ Ø§Ù„Ø­Ø¬Ø²: {context.user_data['payment_code']}\n"
            f"Ø±Ù‚Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„: {transfer_number}\n"
            f"ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø²: {context.user_data['booking_date']}\n\n"
            "Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø·Ù„Ø¨Ùƒ ÙˆØ¥Ø¹Ù„Ø§Ù…Ùƒ Ø¨Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù‚Ø±ÙŠØ¨Ø§Ù‹.\n"
            "ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£Ù…Ø± /status Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø­Ø¬Ø²Ùƒ.\n\n"
            "Ø´ÙƒØ±Ø§Ù‹ Ù„Ø«Ù‚ØªÙƒ Ø¨Ù†Ø§!"
        )
    else:
        await update.message.reply_text(
            "âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¬Ø². Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰."
        )
        return TRANSFER_NUMBER

    return ConversationHandler.END


async def check_status(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.message.from_user.id
    conn = sqlite3.connect(DB_NAME)
    c = conn.cursor()
    c.execute("SELECT * FROM bookings WHERE user_id=?", (user_id,))
    user_bookings = c.fetchall()
    conn.close()

    if not user_bookings:
        await update.message.reply_text("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø£ÙŠ Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø³Ø¬Ù„Ø©.")
        return

    for booking in user_bookings:
        status = "â³ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±" if booking[7] == 'pending' else (
            "âœ… ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©" if 'approved' in booking[7] else
            f"âŒ Ù…Ø±ÙÙˆØ¶: {booking[7].split(':')[-1]}" if ':' in booking[7] else "âŒ Ù…Ø±ÙÙˆØ¶")

        msg = (
            f"ğŸ”„ Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¬Ø²:\n\nğŸ†” ÙƒÙˆØ¯ Ø§Ù„Ø­Ø¬Ø²: <code>{booking[1]}</code>\n"
            f"ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: {booking[2]}\nğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹: {booking[3]}\n"
            f"ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: {booking[5]:,} Ù„.Ø³\nğŸ”¢ Ø±Ù‚Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„: {booking[6]}\n"
            f"ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø²: {booking[10]}\n"
            f"ğŸ“Œ Ø§Ù„Ø­Ø§Ù„Ø©: {status}\n\n"
        )

        if 'approved' in booking[7]:
            msg += "ğŸ‰ ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø­Ø¬Ø²Ùƒ! Ø§Ø³ØªÙ…ØªØ¹ Ø¨ÙˆÙ‚ØªÙƒ!"

        await update.message.reply_text(msg)


async def admin_approve(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.message.from_user
    if not is_admin(user.id):
        await update.message.reply_text("âš ï¸ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©")
        return

    pending = get_pending_bookings()
    if not pending:
        await update.message.reply_text("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ù†ØªØ¸Ø±Ø© Ù„Ù„Ù…ÙˆØ§ÙÙ‚Ø©")
        return

    total_bookings = len(pending)
    total_people = sum(booking[4] for booking in pending)

    await update.message.reply_text(
        f"ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª:\n"
        f"â€¢ Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©: {total_bookings}\n"
        f"â€¢ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ø®Ø§Øµ: {total_people}\n\n"
        "ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª:"
    )

    for booking in pending:
        booking_details = (
            f"ğŸ†” ÙƒÙˆØ¯ Ø§Ù„Ø­Ø¬Ø²: <code>{booking[1]}</code>\n"
            f"ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: {booking[2]}\n"
            f"ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹: {booking[3]}\n"
            f"ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ø®Ø§Øµ: {booking[4]}\n"
            f"ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: {booking[5]:,} Ù„.Ø³\n"
            f"ğŸ”¢ Ø±Ù‚Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„: {booking[6]}\n"
            f"ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø²: {booking[10]}\n"
        )

        keyboard = InlineKeyboardMarkup([
            [InlineKeyboardButton(
                "âœ… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²",
                callback_data=f"approve_{booking[1]}")
            ]
        ])

        await update.message.reply_text(
            booking_details,
            reply_markup=keyboard
        )


async def handle_approve(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    user = query.from_user
    if not is_admin(user.id):
        await query.edit_message_text("âš ï¸ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© ØªÙ†ÙÙŠØ° Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø±")
        return

    payment_code = query.data.split('_')[1]
    if approve_booking(payment_code):
        await notify_user_approval(context, payment_code)
        await query.edit_message_text(
            f"âœ… ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø² {payment_code} Ø¨Ù†Ø¬Ø§Ø­\n"
            "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©"
        )
    else:
        await query.edit_message_text(
            f"âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø² {payment_code}"
        )


async def reject_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.message.from_user
    if not is_admin(user.id):
        await update.message.reply_text("âš ï¸ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© ØªÙ†ÙÙŠØ° Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø±")
        return

    parts = update.message.text.split('_')
    payment_code = parts[1]
    reason = ' '.join(parts[2:]) if len(parts) > 2 else None

    if reject_booking(payment_code, reason):
        msg = f"âœ… ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø­Ø¬Ø² {payment_code}"
        if reason:
            msg += f"\nğŸ“ Ø§Ù„Ø³Ø¨Ø¨: {reason}"
        await update.message.reply_text(msg)
    else:
        await update.message.reply_text(f"âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø² {payment_code}")


async def promote_admin(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.message.from_user
    if not is_admin(user.id):
        await update.message.reply_text("âš ï¸ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© ØªÙ†ÙÙŠØ° Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø±")
        return

    if not context.args:
        await update.message.reply_text("Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…: /promote <user_id> <username> <full_name>")
        return

    user_id = context.args[0]
    username = context.args[1] if len(context.args) > 1 else None
    full_name = ' '.join(context.args[2:]) if len(context.args) > 2 else None

    if add_admin(user_id, username, full_name):
        await update.message.reply_text(
            f"âœ… ØªÙ…Øª ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ù…Ø³Ø¤ÙˆÙ„:\n"
            f"ğŸ†” Ø§Ù„Ø¢ÙŠØ¯ÙŠ: {user_id}\n"
            f"ğŸ“Œ Ø§Ù„ÙŠÙˆØ²Ø±Ù†ÙŠÙ…: @{username if username else 'Ø¨Ø¯ÙˆÙ†'}\n"
            f"ğŸ“› Ø§Ù„Ø§Ø³Ù…: {full_name if full_name else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}"
        )
    else:
        await update.message.reply_text("âš ï¸ ÙØ´Ù„ ÙÙŠ ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ù‡Ùˆ Ù…Ø³Ø¤ÙˆÙ„ Ø¨Ø§Ù„ÙØ¹Ù„")


async def demote_admin(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.message.from_user
    if not is_admin(user.id):
        await update.message.reply_text("âš ï¸ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© ØªÙ†ÙÙŠØ° Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø±")
        return

    if not context.args:
        await update.message.reply_text("Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…: /demote <user_id>")
        return

    user_id = context.args[0]
    if remove_admin(user_id):
        await update.message.reply_text(f"âœ… ØªÙ… Ø¥Ø²Ø§Ù„Ø© ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ù…Ù† {user_id}")
    else:
        await update.message.reply_text("âš ï¸ ÙØ´Ù„ ÙÙŠ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø£Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ÙŠØ³ Ù…Ø³Ø¤ÙˆÙ„Ø§Ù‹")


async def list_admins_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.message.from_user
    if not is_admin(user.id):
        await update.message.reply_text("âš ï¸ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© ØªÙ†ÙÙŠØ° Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø±")
        return

    admins = list_admins()
    if not admins:
        await update.message.reply_text("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹")
        return

    message = "ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†:\n\n"
    for admin in admins:
        message += (
            f"ğŸ†” Ø§Ù„Ø¢ÙŠØ¯ÙŠ: {admin[0]}\n"
            f"ğŸ“Œ Ø§Ù„ÙŠÙˆØ²Ø±Ù†ÙŠÙ…: @{admin[1] if admin[1] else 'Ø¨Ø¯ÙˆÙ†'}\n"
            f"ğŸ“› Ø§Ù„Ø§Ø³Ù…: {admin[2] if admin[2] else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\n"
            f"ğŸ•’ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©: {admin[3]}\n\n"
        )

    await update.message.reply_text(message)


async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©",
        reply_markup=ReplyKeyboardMarkup([
            ["ğŸŠ Ø§Ù„Ù…Ø³Ø§Ø¨Ø­", "ğŸ½ï¸ Ø§Ù„Ù…Ø·Ø§Ø¹Ù…"],
            ["ğŸ‰ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø®Ø§ØµØ©", "ğŸ“ Ø§ØªØµÙ„ Ø¨Ù†Ø§"],
            ["ğŸ“… Ø­Ø¬Ø² Ø·Ø§ÙˆÙ„Ø©", "ğŸ†” Ù…Ø¹Ø±ÙÙŠ"]
        ], resize_keyboard=True)
    )
    return ConversationHandler.END


async def unknown_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ø§ Ø£ÙÙ‡Ù… Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø±.\n"
        "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ØªØ§Ø­Ø© Ø£Ùˆ ÙƒØªØ§Ø¨Ø© /start Ù„Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯.",
        reply_markup=ReplyKeyboardMarkup([
            ["ğŸŠ Ø§Ù„Ù…Ø³Ø§Ø¨Ø­", "ğŸ½ï¸ Ø§Ù„Ù…Ø·Ø§Ø¹Ù…"],
            ["ğŸ‰ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø®Ø§ØµØ©", "ğŸ“ Ø§ØªØµÙ„ Ø¨Ù†Ø§"],
            ["ğŸ“… Ø­Ø¬Ø² Ø·Ø§ÙˆÙ„Ø©", "ğŸ†” Ù…Ø¹Ø±ÙÙŠ"]
        ], resize_keyboard=True)
    )


def main():
    try:
        app = Application.builder().token("7992401524:AAEIKl5ECMeIl24bRlw3A3_2j_0Uvae0yLQ").build()

        conv_handler = ConversationHandler(
            entry_points=[
                MessageHandler(filters.Regex(r'^(ğŸ“… Ø­Ø¬Ø² Ø·Ø§ÙˆÙ„Ø©|Ø­Ø¬Ø² Ø·Ø§ÙˆÙ„Ø©|Ø­Ø¬Ø²|booking|book)$'), start_booking)
            ],
            states={
                LOCATION: [CallbackQueryHandler(select_location)],
                NAME: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_name)],
                PEOPLE: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_people)],
                BOOKING_DATE: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_booking_date)],
                CONFIRM: [CallbackQueryHandler(confirm_booking)],
                TRANSFER_NUMBER: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_transfer_number)]
            },
            fallbacks=[
                CommandHandler('cancel', cancel),
                MessageHandler(filters.Regex(r'^(Ø¥Ù„ØºØ§Ø¡|Ø§Ù„ØºØ§Ø¡|ØªØ±Ø§Ø¬Ø¹)$'), cancel)
            ],
            allow_reentry=True,
            per_user=True
        )

        app.add_handler(conv_handler)
        app.add_handler(CommandHandler("start", start))
        app.add_handler(CommandHandler("status", check_status))
        app.add_handler(CommandHandler("admin", admin_approve))
        app.add_handler(CallbackQueryHandler(handle_approve, pattern=r'^approve_'))
        app.add_handler(CommandHandler("reject", reject_command))
        app.add_handler(CommandHandler("promote", promote_admin))
        app.add_handler(CommandHandler("demote", demote_admin))
        app.add_handler(CommandHandler("admins", list_admins_cmd))
        app.add_handler(CommandHandler("myid", show_ids))
        app.add_handler(MessageHandler(filters.Regex(r'^ğŸ†” Ù…Ø¹Ø±ÙÙŠ$'), handle_myid_button))
        app.add_handler(MessageHandler(filters.Regex(r'^ğŸ“‹ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§$'), show_approved_bookings))
        app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, unknown_command))

        logger.info("ğŸš€ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª...")
        app.run_polling(drop_pending_updates=True)

    except Exception as e:
        logger.error(f"Ø­Ø¯Ø« Ø®Ø·Ø£: {str(e)}")
    finally:
        logger.info("Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª")


if __name__ == "__main__":
    if not list_admins():
        add_admin(
            user_id="5901137890",
            username="Bashar8100",
            full_name="Ø¨Ø´Ø§Ø±"
        )
    main()